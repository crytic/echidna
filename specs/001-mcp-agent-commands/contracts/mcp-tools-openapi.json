{
  "openapi": "3.1.0",
  "info": {
    "title": "Echidna MCP Tools API",
    "version": "1.0.0",
    "description": "MCP (Model Context Protocol) tool definitions for Echidna fuzzer agent integration. Implements 9 tools: 6 observability + 3 control commands."
  },
  "servers": [
    {
      "url": "http://localhost:8080",
      "description": "Default Echidna MCP server"
    }
  ],
  "paths": {
    "/mcp/tools": {
      "get": {
        "summary": "List available MCP tools",
        "description": "Returns metadata for all 9 registered tools",
        "responses": {
          "200": {
            "description": "Tool registry",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ToolRegistry"
                }
              }
            }
          }
        }
      }
    },
    "/mcp/tools/read_logs": {
      "post": {
        "summary": "Read campaign event logs",
        "description": "FR-001: Retrieve last N events from EventLog ring buffer (max 2500 entries)",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/ReadLogsInput"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Event log entries",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ReadLogsOutput"
                }
              }
            }
          }
        }
      }
    },
    "/mcp/tools/show_coverage": {
      "post": {
        "summary": "Show current coverage statistics",
        "description": "FR-002: Return per-contract line/branch coverage percentages",
        "requestBody": {
          "required": false,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/ShowCoverageInput"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Coverage data",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ShowCoverageOutput"
                }
              }
            }
          }
        }
      }
    },
    "/mcp/tools/dump_lcov": {
      "post": {
        "summary": "Export coverage in LCOV format",
        "description": "FR-003: Generate LCOV-formatted coverage report for tooling integration",
        "requestBody": {
          "required": false,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/DumpLcovInput"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "LCOV report",
            "content": {
              "text/plain": {
                "schema": {
                  "type": "string",
                  "example": "TN:\nSF:/path/to/Contract.sol\nFN:10,functionName\n..."
                }
              }
            }
          }
        }
      }
    },
    "/mcp/tools/get_corpus_size": {
      "post": {
        "summary": "Get current corpus transaction count",
        "description": "FR-004: Return number of transactions in corpus",
        "requestBody": {
          "required": false,
          "content": {
            "application/json": {
              "schema": {
                "type": "object"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Corpus size",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/GetCorpusSizeOutput"
                }
              }
            }
          }
        }
      }
    },
    "/mcp/tools/inspect_corpus_transactions": {
      "post": {
        "summary": "Inspect corpus transaction details",
        "description": "FR-004: Retrieve structured view of corpus transactions with pagination",
        "requestBody": {
          "required": false,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/InspectCorpusInput"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Transaction details",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/InspectCorpusOutput"
                }
              }
            }
          }
        }
      }
    },
    "/mcp/tools/find_transaction_in_corpus": {
      "post": {
        "summary": "Search corpus for matching transactions",
        "description": "FR-004: Find transactions by function signature, sender, or value",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/FindTransactionInput"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Matching transactions",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/FindTransactionOutput"
                }
              }
            }
          }
        }
      }
    },
    "/mcp/tools/inject_transaction": {
      "post": {
        "summary": "Inject external transaction sequence",
        "description": "FR-005: Add transaction sequence to all workers (Clarification #5: broadcast). Logged to mcp-commands.jsonl (FR-010).",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/InjectTransactionInput"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Injection result",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/InjectTransactionOutput"
                }
              }
            }
          }
        }
      }
    },
    "/mcp/tools/prioritize_function": {
      "post": {
        "summary": "Prioritize function in fuzzing",
        "description": "FR-006: Add function signature to prioritization set (90% weighted, Clarification #2). Logged to mcp-commands.jsonl (FR-010).",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/PrioritizeFunctionInput"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Prioritization result",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/PrioritizeFunctionOutput"
                }
              }
            }
          }
        }
      }
    },
    "/mcp/tools/clear_priorities": {
      "post": {
        "summary": "Clear all function priorities",
        "description": "FR-007: Reset prioritization set to empty. Logged to mcp-commands.jsonl (FR-010).",
        "requestBody": {
          "required": false,
          "content": {
            "application/json": {
              "schema": {
                "type": "object"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Clear result",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ClearPrioritiesOutput"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "ToolRegistry": {
        "type": "object",
        "properties": {
          "tools": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/ToolMetadata"
            }
          }
        },
        "required": ["tools"]
      },
      "ToolMetadata": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string",
            "pattern": "^[a-z_]+$"
          },
          "description": {
            "type": "string"
          },
          "inputSchema": {
            "type": "object"
          }
        },
        "required": ["name", "description", "inputSchema"]
      },
      "ReadLogsInput": {
        "type": "object",
        "properties": {
          "count": {
            "type": "integer",
            "minimum": 1,
            "maximum": 2500,
            "default": 100,
            "description": "Number of most recent events to retrieve"
          },
          "eventType": {
            "type": "string",
            "description": "Filter by event type (optional)",
            "enum": ["PropertyFalsified", "TransactionExecuted", "CoverageIncreased", "WorkerStarted", "WorkerStopped"]
          },
          "workerId": {
            "type": "integer",
            "minimum": 0,
            "description": "Filter by worker ID (optional)"
          }
        }
      },
      "ReadLogsOutput": {
        "type": "object",
        "properties": {
          "events": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/EventEntry"
            }
          },
          "totalCount": {
            "type": "integer",
            "description": "Total events in log (up to 2500)"
          }
        },
        "required": ["events", "totalCount"]
      },
      "EventEntry": {
        "type": "object",
        "properties": {
          "timestamp": {
            "type": "string",
            "format": "date-time",
            "example": "2025-12-20T10:30:45"
          },
          "eventType": {
            "type": "string",
            "example": "PropertyFalsified"
          },
          "workerId": {
            "type": "integer",
            "example": 2
          },
          "data": {
            "type": "object",
            "description": "Event-specific JSON payload",
            "example": {
              "property": "echidna_balance_check",
              "counterexample": ["deposit(100)", "withdraw(200)"]
            }
          }
        },
        "required": ["timestamp", "eventType", "workerId", "data"]
      },
      "ShowCoverageInput": {
        "type": "object",
        "properties": {
          "contract": {
            "type": "string",
            "description": "Filter by contract name (optional)"
          }
        }
      },
      "ShowCoverageOutput": {
        "type": "object",
        "properties": {
          "contracts": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/ContractCoverage"
            }
          },
          "overallCoverage": {
            "type": "number",
            "format": "float",
            "minimum": 0,
            "maximum": 100,
            "description": "Weighted average across all contracts"
          }
        },
        "required": ["contracts", "overallCoverage"]
      },
      "ContractCoverage": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string",
            "example": "MyToken"
          },
          "lineCoverage": {
            "type": "number",
            "format": "float",
            "minimum": 0,
            "maximum": 100,
            "example": 85.5
          },
          "branchCoverage": {
            "type": "number",
            "format": "float",
            "minimum": 0,
            "maximum": 100,
            "example": 72.3
          }
        },
        "required": ["name", "lineCoverage", "branchCoverage"]
      },
      "DumpLcovInput": {
        "type": "object",
        "properties": {
          "outputPath": {
            "type": "string",
            "description": "Optional output file path (defaults to stdout)"
          }
        }
      },
      "GetCorpusSizeOutput": {
        "type": "object",
        "properties": {
          "size": {
            "type": "integer",
            "minimum": 0,
            "example": 1523
          }
        },
        "required": ["size"]
      },
      "InspectCorpusInput": {
        "type": "object",
        "properties": {
          "offset": {
            "type": "integer",
            "minimum": 0,
            "default": 0,
            "description": "Pagination offset"
          },
          "limit": {
            "type": "integer",
            "minimum": 1,
            "maximum": 100,
            "default": 20,
            "description": "Max transactions to return"
          }
        }
      },
      "InspectCorpusOutput": {
        "type": "object",
        "properties": {
          "transactions": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/TransactionDetail"
            }
          },
          "total": {
            "type": "integer",
            "description": "Total corpus size"
          }
        },
        "required": ["transactions", "total"]
      },
      "TransactionDetail": {
        "type": "object",
        "properties": {
          "index": {
            "type": "integer",
            "example": 42
          },
          "call": {
            "type": "string",
            "description": "Solidity-like function call syntax (Clarification #1)",
            "example": "transfer(0x123..., 100)"
          },
          "sender": {
            "type": "string",
            "example": "0xabc..."
          },
          "value": {
            "type": "string",
            "description": "ETH value in wei",
            "example": "1000000000000000000"
          },
          "gasUsed": {
            "type": "integer",
            "example": 21000
          }
        },
        "required": ["index", "call", "sender", "value"]
      },
      "FindTransactionInput": {
        "type": "object",
        "properties": {
          "functionSignature": {
            "type": "string",
            "description": "Function signature to search for (e.g., 'transfer(address,uint256)')"
          },
          "sender": {
            "type": "string",
            "pattern": "^0x[0-9a-fA-F]{40}$",
            "description": "Sender address filter"
          },
          "minValue": {
            "type": "string",
            "description": "Minimum ETH value in wei"
          }
        },
        "anyOf": [
          {"required": ["functionSignature"]},
          {"required": ["sender"]},
          {"required": ["minValue"]}
        ]
      },
      "FindTransactionOutput": {
        "type": "object",
        "properties": {
          "matches": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/TransactionDetail"
            }
          },
          "count": {
            "type": "integer",
            "description": "Number of matching transactions"
          }
        },
        "required": ["matches", "count"]
      },
      "InjectTransactionInput": {
        "type": "object",
        "properties": {
          "sequence": {
            "type": "array",
            "items": {
              "type": "string",
              "description": "Solidity-like function call (Clarification #1)",
              "example": "transfer(0x123..., 100)"
            },
            "minItems": 1,
            "maxItems": 100
          },
          "sender": {
            "type": "string",
            "pattern": "^0x[0-9a-fA-F]{40}$",
            "default": "0x0000000000000000000000000000000000010000",
            "description": "Transaction sender address"
          },
          "value": {
            "type": "string",
            "default": "0",
            "description": "ETH value in wei"
          }
        },
        "required": ["sequence"]
      },
      "InjectTransactionOutput": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean"
          },
          "message": {
            "type": "string",
            "example": "Injected 3 transactions to 4 workers"
          },
          "injectedCount": {
            "type": "integer",
            "description": "Number of transactions injected"
          }
        },
        "required": ["success", "message", "injectedCount"]
      },
      "PrioritizeFunctionInput": {
        "type": "object",
        "properties": {
          "functionSignature": {
            "type": "string",
            "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*\\([^)]*\\)$",
            "description": "Canonical ABI function signature",
            "example": "transfer(address,uint256)"
          }
        },
        "required": ["functionSignature"]
      },
      "PrioritizeFunctionOutput": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean"
          },
          "message": {
            "type": "string",
            "example": "Prioritized function 'transfer(address,uint256)'"
          },
          "prioritizedFunctions": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Current set of prioritized functions"
          }
        },
        "required": ["success", "message", "prioritizedFunctions"]
      },
      "ClearPrioritiesOutput": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean"
          },
          "message": {
            "type": "string",
            "example": "Cleared all function priorities"
          },
          "clearedCount": {
            "type": "integer",
            "description": "Number of functions cleared"
          }
        },
        "required": ["success", "message", "clearedCount"]
      }
    }
  }
}
